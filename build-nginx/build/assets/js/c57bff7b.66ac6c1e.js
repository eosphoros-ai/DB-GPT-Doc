"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4519],{1246:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>_,frontMatter:()=>r,metadata:()=>d,toc:()=>l});var a=t(4848),i=t(8453);const r={},s="Fine-Tuning use dbgpt_hub",d={id:"application/fine_tuning_manual/dbgpt_hub",title:"Fine-Tuning use dbgpt_hub",description:"The DB-GPT-Hub project has released a pip package to lower the threshold for Text2SQL training. In addition to fine-tuning through the scripts provided in the warehouse, you can alse use the Python package we provide",source:"@site/versioned_docs/version-v0.5.1/application/fine_tuning_manual/dbgpt_hub.md",sourceDirName:"application/fine_tuning_manual",slug:"/application/fine_tuning_manual/dbgpt_hub",permalink:"/docs/v0.5.1/application/fine_tuning_manual/dbgpt_hub",draft:!1,unlisted:!1,tags:[],version:"v0.5.1",frontMatter:{},sidebar:"docs",previous:{title:"Text2SQL Fine-Tuning",permalink:"/docs/v0.5.1/application/fine_tuning_manual/text_to_sql"},next:{title:"Modules",permalink:"/docs/v0.5.1/modules"}},o={},l=[{value:"Install",id:"install",level:2},{value:"Show Baseline",id:"show-baseline",level:2},{value:"Fine-tuning",id:"fine-tuning",level:2}];function p(e){const n={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"fine-tuning-use-dbgpt_hub",children:"Fine-Tuning use dbgpt_hub"}),"\n",(0,a.jsx)(n.p,{children:"The DB-GPT-Hub project has released a pip package to lower the threshold for Text2SQL training. In addition to fine-tuning through the scripts provided in the warehouse, you can alse use the Python package we provide\nfor fine-tuning."}),"\n",(0,a.jsx)(n.h2,{id:"install",children:"Install"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"pip install dbgpt_hub\n"})}),"\n",(0,a.jsx)(n.h2,{id:"show-baseline",children:"Show Baseline"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"from dbgpt_hub.baseline import show_scores\nshow_scores()\n"})}),"\n",(0,a.jsx)("p",{align:"left",children:(0,a.jsx)("img",{src:"/img/ft/baseline.png",width:"720px"})}),"\n",(0,a.jsx)(n.h2,{id:"fine-tuning",children:"Fine-tuning"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:"from dbgpt_hub.data_process import preprocess_sft_data\nfrom dbgpt_hub.train import train_sft\nfrom dbgpt_hub.predict import start_predict\nfrom dbgpt_hub.eval import start_evaluate\n"})}),"\n",(0,a.jsx)(n.p,{children:"Preprocessing data into fine-tuned data format."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'data_folder = "dbgpt_hub/data"\ndata_info = [\n     {\n        "data_source": "spider",\n        "train_file": ["train_spider.json", "train_others.json"],\n        "dev_file": ["dev.json"],\n        "tables_file": "tables.json",\n        "db_id_name": "db_id",\n        "is_multiple_turn": False,\n        "train_output": "spider_train.json",\n        "dev_output": "spider_dev.json",\n    }\n]\n\npreprocess_sft_data(\n      data_folder = data_folder,\n      data_info = data_info\n)\n'})}),"\n",(0,a.jsx)(n.p,{children:"Fine-tune the basic model and generate model weights"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'train_args = {\n            "model_name_or_path": "codellama/CodeLlama-13b-Instruct-hf",\n            "do_train": True,\n            "dataset": "example_text2sql_train",\n            "max_source_length": 2048,\n            "max_target_length": 512,\n            "finetuning_type": "lora",\n            "lora_target": "q_proj,v_proj",\n            "template": "llama2",\n            "lora_rank": 64,\n            "lora_alpha": 32,\n            "output_dir": "dbgpt_hub/output/adapter/CodeLlama-13b-sql-lora",\n            "overwrite_cache": True,\n            "overwrite_output_dir": True,\n            "per_device_train_batch_size": 1,\n            "gradient_accumulation_steps": 16,\n            "lr_scheduler_type": "cosine_with_restarts",\n            "logging_steps": 50,\n            "save_steps": 2000,\n            "learning_rate": 2e-4,\n            "num_train_epochs": 8,\n            "plot_loss": True,\n            "bf16": True,\n}\n\nstart_sft(train_args)\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"Predictive model output results"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'predict_args = {\n            "model_name_or_path": "codellama/CodeLlama-13b-Instruct-hf",\n            "template": "llama2",\n            "finetuning_type": "lora",\n            "checkpoint_dir": "dbgpt_hub/output/adapter/CodeLlama-13b-sql-lora",\n            "predict_file_path": "dbgpt_hub/data/eval_data/dev_sql.json",\n            "predict_out_dir": "dbgpt_hub/output/",\n            "predicted_out_filename": "pred_sql.sql",\n}\nstart_predict(predict_args)\n\n'})}),"\n",(0,a.jsx)(n.p,{children:"Evaluate the accuracy of the output results on the test datasets"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'evaluate_args =  {\n            "input": "./dbgpt_hub/output/pred/pred_sql_dev_skeleton.sql",\n            "gold": "./dbgpt_hub/data/eval_data/gold.txt",\n            "gold_natsql": "./dbgpt_hub/data/eval_data/gold_natsql2sql.txt",\n            "db": "./dbgpt_hub/data/spider/database",\n            "table": "./dbgpt_hub/data/eval_data/tables.json",\n            "table_natsql": "./dbgpt_hub/data/eval_data/tables_for_natsql2sql.json",\n            "etype": "exec",\n            "plug_value": True,\n            "keep_distict": False,\n            "progress_bar_for_each_datapoint": False,\n            "natsql": False,\n}\nstart_evaluate(evaluate_args)\n'})})]})}function _(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>d});var a=t(6540);const i={},r=a.createContext(i);function s(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);