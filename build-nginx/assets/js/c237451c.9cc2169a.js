"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1167],{193:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var n=r(4848),s=r(8453);const a={},i="3.4 Handling Streaming Requests",o={id:"awel/awel_tutorial/network_program/3.4_http_trigger_streaming",title:"3.4 Handling Streaming Requests",description:"In this section, we will create a new HTTP trigger that returns a streaming response",source:"@site/versioned_docs/version-v0.5.1/awel/awel_tutorial/network_program/3.4_http_trigger_streaming.md",sourceDirName:"awel/awel_tutorial/network_program",slug:"/awel/awel_tutorial/network_program/3.4_http_trigger_streaming",permalink:"/docs/v0.5.1/awel/awel_tutorial/network_program/3.4_http_trigger_streaming",draft:!1,unlisted:!1,tags:[],version:"v0.5.1",frontMatter:{},sidebar:"docs",previous:{title:"3.3 Handling Post Requests",permalink:"/docs/v0.5.1/awel/awel_tutorial/network_program/3.3_http_trigger_post"},next:{title:"4.1 AWEL Lifecycle",permalink:"/docs/v0.5.1/awel/awel_tutorial/advanced_guide/4.1_lifecycle"}},l={},d=[{value:"Stream The Numbers",id:"stream-the-numbers",level:2}];function c(e){const t={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"34-handling-streaming-requests",children:"3.4 Handling Streaming Requests"}),"\n",(0,n.jsx)(t.p,{children:"In this section, we will create a new HTTP trigger that returns a streaming response\nbased on the request body of the POST request."}),"\n",(0,n.jsx)(t.h2,{id:"stream-the-numbers",children:"Stream The Numbers"}),"\n",(0,n.jsxs)(t.p,{children:["Create a new file named ",(0,n.jsx)(t.code,{children:"http_trigger_stream_numbers.py"})," in the ",(0,n.jsx)(t.code,{children:"awel_tutorial"})," directory"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:'from dbgpt._private.pydantic import BaseModel, Field\nfrom dbgpt.core.awel import DAG, HttpTrigger, StreamifyAbsOperator, setup_dev_environment\nfrom typing import AsyncIterator\n\nclass TriggerReqBody(BaseModel):\n    n: int = Field(..., description="The number of integers to be streamed")\n\nclass NumberProducerOperator(StreamifyAbsOperator[TriggerReqBody, int]):\n    """Create a stream of numbers from 0 to `n-1`"""\n    async def streamify(self, req: TriggerReqBody) -> AsyncIterator[int]:\n        for i in range(req.n):\n            yield str(i) + "\\n"\n\nwith DAG("awel_stream_numbers") as dag:\n    trigger_task = HttpTrigger(\n        endpoint="/awel_tutorial/stream_numbers", \n        methods="POST", \n        request_body=TriggerReqBody,\n        status_code=200,\n        streaming_predict_func=lambda x: True\n    )\n    task = NumberProducerOperator()\n    trigger_task >> task\n\nsetup_dev_environment([dag], port=5555)\n'})}),"\n",(0,n.jsx)(t.p,{children:"And run the following command to execute the code:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"poetry run python awel_tutorial/http_trigger_stream_numbers.py\n"})}),"\n",(0,n.jsx)(t.p,{children:"Now, open a new terminal and run the following command to send a POST request to the server:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'curl -X POST \\\n"http://127.0.0.1:5555/api/v1/awel/trigger/awel_tutorial/stream_numbers" \\\n-H "Content-Type: application/json" \\\n-d \'{"n": 5}\'\n'})}),"\n",(0,n.jsx)(t.p,{children:"The output should look like this:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-plaintext",children:"0\n1\n2\n3\n4\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Then you can stop the server by pressing ",(0,n.jsx)(t.code,{children:"Ctrl+C"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["In this example, we created a ",(0,n.jsx)(t.code,{children:"HttpTrigger"})," operator with a streaming predict function\nwhich is used to determine whether to stream the response(it always returns ",(0,n.jsx)(t.code,{children:"True"})," in this example)."]})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},8453:(e,t,r)=>{r.d(t,{R:()=>i,x:()=>o});var n=r(6540);const s={},a=n.createContext(s);function i(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);